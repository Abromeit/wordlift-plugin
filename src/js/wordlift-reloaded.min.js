(function(){var a,b,c,d,e=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};b=function(){function a(a){this._html=a}var b;return a.prototype._htmlPositions=[],a.prototype._textPositions=[],a.prototype._html="",a.prototype._text="",b=function(a){var b;return b=document.createElement("textarea"),b.innerHTML=a,b.value},a.create=function(b){var c;return c=new a(b),c.parse(),c},a.prototype.parse=function(){var a,c,d,e,f,g,h,i,j,k,l;for(this._htmlPositions=[],this._textPositions=[],this._text="",h=/([^&<>]*)(&[^&;]*;|<[^>]*>)([^&<>]*)/gim,j=0,c=0;g=h.exec(this._html);)e=g[1],a=g[2],d=g[3],l=e+("</p>"===(i=a.toLowerCase())||"</li>"===i?"\n\n":""),k=d,j+=l.length,/^&[^&;]*;$/gim.test(a)&&(j+=1),c+=e.length+a.length,this._htmlPositions.push(c),this._textPositions.push(j),j+=k.length,c+=d.length,f="",/^&[^&;]*;$/gim.test(a)&&(f=b(a)),this._text+=l+f+k;return""===this._text&&""!==this._html&&(this._text=new String(this._html)),0===this._textPositions.length||0!==this._textPositions[0]?(this._htmlPositions.unshift(0),this._textPositions.unshift(0)):void 0},a.prototype.text2html=function(a){var b,c,d,e,f;for(b=0,f=0,c=d=0,e=this._textPositions.length;(e>=0?e>d:d>e)&&!(a<this._textPositions[c]);c=e>=0?++d:--d)b=this._htmlPositions[c],f=this._textPositions[c];return b+a-f},a.prototype.html2text=function(a){var b,c,d,e,f;if(a<this._htmlPositions[0])return 0;for(b=0,f=0,c=d=0,e=this._htmlPositions.length;(e>=0?e>d:d>e)&&!(a<this._htmlPositions[c]);c=e>=0?++d:--d)b=this._htmlPositions[c],f=this._textPositions[c];return f+a-b},a.prototype.insertHtml=function(a,b){var c;return c=this.text2html(b.text),this._html=this._html.substring(0,c)+a+this._html.substring(c),this.parse()},a.prototype.getHtml=function(){return this._html},a.prototype.getText=function(){return this._text},a}(),window.Traslator=b,angular.module("wordlift.utils.directives",[]).directive("wlOnError",["$parse","$window","$log",function(a,b,c){return{restrict:"A",compile:function(b,c){return function(b,d){var e;return e=a(c.wlOnError),d.on("error",function(a){var c;return c=function(){return e(b,{$event:a})},b.$apply(c)})}}}}]).directive("wlFallback",["$window","$log",function(a,b){return{restrict:"A",priority:99,link:function(a,c,d,e){return c.bind("error",function(){return d.src!==d.wlFallback?(b.warn("Error on "+d.src+"! Going to fallback on "+d.wlFallback),d.$set("src",d.wlFallback)):void 0})}}}]),angular.module("wordlift.ui.carousel",[]).directive("wlCarousel",["$window","$log",function(a,b){return{restrict:"A",scope:!0,transclude:!0,template:'<div class="wl-carousel" ng-class="{ \'active\' : areControlsVisible }" ng-show="panes.length > 0" ng-mouseover="showControls()" ng-mouseleave="hideControls()">\n  <div class="wl-panes" ng-style="{ width: panesWidth, left: position }" ng-transclude></div>\n  <div class="wl-carousel-arrow wl-prev" ng-click="prev()" ng-show="isPrevArrowVisible()">\n    <i class="wl-angle-left" />\n  </div>\n  <div class="wl-carousel-arrow wl-next" ng-click="next()" ng-show="isNextArrowVisible()">\n    <i class="wl-angle-right" />\n  </div>\n</div>',controller:["$scope","$element","$attrs","$log",function(b,c,d,e){var f,g;return g=angular.element(a),b.setItemWidth=function(){return c.width()/b.visibleElements()},b.showControls=function(){return b.areControlsVisible=!0},b.hideControls=function(){return b.areControlsVisible=!1},b.visibleElements=function(){return c.width()>460?4:1},b.isPrevArrowVisible=function(){return b.areControlsVisible?b.currentPaneIndex>0:!1},b.isNextArrowVisible=function(){return b.areControlsVisible?b.panes.length-b.currentPaneIndex>b.visibleElements():!1},b.next=function(){return b.position=b.position-b.itemWidth,b.currentPaneIndex=b.currentPaneIndex+1},b.prev=function(){return b.position=b.position+b.itemWidth,b.currentPaneIndex=b.currentPaneIndex-1},b.setPanesWrapperWidth=function(){return b.panesWidth=b.panes.length*b.itemWidth,b.position=0,b.currentPaneIndex=0},b.itemWidth=b.setItemWidth(),b.panesWidth=void 0,b.panes=[],b.position=0,b.currentPaneIndex=0,b.areControlsVisible=!1,g.bind("resize",function(){var a,c,d,e;for(b.itemWidth=b.setItemWidth(),b.setPanesWrapperWidth(),e=b.panes,a=0,c=e.length;c>a;a++)d=e[a],d.scope.setWidth(b.itemWidth);return b.$apply()}),f=this,f.registerPane=function(a,c){var d;return a.setWidth(b.itemWidth),d={scope:a,element:c},b.panes.push(d),b.setPanesWrapperWidth()},f.unregisterPane=function(a){var c,d,e,f,g,h;for(h=void 0,g=b.panes,c=d=0,e=g.length;e>d;c=++d)f=g[c],f.scope.$id===a.$id&&(h=c);return b.panes.splice(h,1),b.setPanesWrapperWidth()}}]}}]).directive("wlCarouselPane",["$log",function(a){return{require:"^wlCarousel",restrict:"EA",transclude:!0,template:"<div ng-transclude></div>",link:function(b,c,d,e){return a.debug("Going to add carousel pane with id "+b.$id+" to carousel"),c.addClass("wl-carousel-item"),b.setWidth=function(a){return c.css("width",a+"px")},b.$on("$destroy",function(){return a.debug("Destroy "+b.$id),e.unregisterPane(b)}),e.registerPane(b,c)}}}]),angular.module("wordlift.editpost.widget.controllers.EditPostWidgetController",["wordlift.editpost.widget.services.AnalysisService","wordlift.editpost.widget.services.EditorService","wordlift.editpost.widget.providers.ConfigurationProvider"]).filter("filterEntitiesByTypesAndRelevance",["configuration","$log",function(a,b){return function(b,c){var d,f,g,h,i,j;if(g=[],null==b)return g;j=Math.floor(1/120*Object.keys(b).length+.75);for(h in b)if(f=b[h],i=f.mainType,e.call(c,i)>=0){if(d=Object.keys(f.annotations).length,0===d)continue;if(d>j&&1===f.confidence){g.push(f);continue}if(f.occurrences.length>0){g.push(f);continue}f.id.startsWith(a.datasetUri)&&g.push(f)}return g}}]).filter("filterEntitiesByTypes",["$log",function(a){return function(a,b){var c,d,f,g;d=[];for(f in a)c=a[f],g=c.mainType,e.call(b,g)>=0&&d.push(c);return d}}]).filter("isEntitySelected",["$log",function(a){return function(a){var b,c,d;c=[];for(d in a)b=a[d],b.occurrences.length>0&&c.push(b);return c}}]).controller("EditPostWidgetController",["RelatedPostDataRetrieverService","EditorService","AnalysisService","configuration","$log","$scope","$rootScope","$compile",function(a,b,c,d,f,g,h,i){var j,k,l,m;for(g.isRunning=!1,g.analysis=void 0,g.relatedPosts=void 0,g.newEntity=c.createEntity(),g.selectedEntities={},g.annotation=void 0,g.boxes=[],g.images={},g.isThereASelection=!1,g.configuration=d,g.errors=[],a.load(Object.keys(g.configuration.entities)),h.$on("analysisFailed",function(a,b){return g.addError(b)}),h.$on("analysisServiceStatusUpdated",function(a,c){return g.isRunning=c,b.updateContentEditableStatus(!c)}),h.$watch("selectionStatus",function(){return g.isThereASelection=h.selectionStatus}),m=g.configuration.classificationBoxes,k=0,l=m.length;l>k;k++)j=m[k],g.selectedEntities[j.id]={};return g.addError=function(a){return g.errors.unshift({type:"error",msg:a})},g.createTextAnnotationFromCurrentSelection=function(){return b.createTextAnnotationFromCurrentSelection()},g.selectAnnotation=function(a){return b.selectAnnotation(a)},g.hasAnalysis=function(){return null!=g.analysis},g.isEntitySelected=function(a,b){return null!=g.selectedEntities[b.id][a.id]},g.isLinkedToCurrentAnnotation=function(a){var b;return b=g.annotation,e.call(a.occurrences,b)>=0},g.addNewEntityToAnalysis=function(a){var b;return g.newEntity.sameAs&&(g.newEntity.sameAs=[g.newEntity.sameAs]),delete g.newEntity.suggestedSameAs,g.analysis.entities[g.newEntity.id]=g.newEntity,b=g.analysis.annotations[g.annotation],b.entityMatches.push({entityId:g.newEntity.id,confidence:1}),g.analysis.entities[g.newEntity.id].annotations[b.id]=b,g.analysis.annotations[g.annotation].entities[g.newEntity.id]=g.newEntity,g.onSelectedEntityTile(g.analysis.entities[g.newEntity.id],a)},g.$on("updateOccurencesForEntity",function(a,b,c){var d,e,h;if(f.debug("Occurrences "+c.length+" for "+b),g.analysis.entities[b].occurrences=c,0===c.length){e=g.selectedEntities,h=[];for(j in e)d=e[j],h.push(delete g.selectedEntities[j][b]);return h}}),g.$watch("annotation",function(a){var b;return f.debug("Current annotation id changed to "+a),g.isRunning||null==a?void 0:(g.newEntity=c.createEntity(),b=g.analysis.annotations[a],g.newEntity.label=b.text,c.getSuggestedSameAs(b.text))}),g.$on("textAnnotationClicked",function(a,b){var c,d,e;g.annotation=b,d=g.boxes,e=[];for(c in d)j=d[c],e.push(j.addEntityFormIsVisible=!1);return e}),g.$on("textAnnotationAdded",function(a,b){return f.debug("added a new annotation with Id "+b.id),g.analysis.annotations[b.id]=b,g.annotation=b.id}),g.$on("sameAsRetrieved",function(a,b){return g.newEntity.suggestedSameAs=b}),g.$on("relatedPostsLoaded",function(a,b){return g.relatedPosts=b}),g.$on("analysisPerformed",function(a,b){var c,d,e,h,i,k,l;for(g.analysis=b,i=g.configuration.classificationBoxes,k=[],e=0,h=i.length;h>e;e++)j=i[e],k.push(function(){var a,e,h,i;for(h=j.selectedEntities,i=[],a=0,e=h.length;e>a;a++)if(d=h[a],c=b.entities[d]){if(0===c.occurrences.length){f.warn("Entity "+d+" selected as "+j.label+" without valid occurences!");continue}g.selectedEntities[j.id][d]=b.entities[d],i.push(function(){var a,b,d,e;for(d=c.images,e=[],b=0,a=d.length;a>b;b++)l=d[b],e.push(g.images[l]=c.label);return e}())}else i.push(f.warn("Entity with id "+d+" should be linked to "+j.id+" but is missing"));return i}());return k}),g.updateRelatedPosts=function(){var b,c,d,e,h;f.debug("Going to update related posts box ..."),d=[],h=g.selectedEntities;for(j in h){b=h[j];for(e in b)c=b[e],d.push(e)}return a.load(d)},g.onSelectedEntityTile=function(a,b){var c,d,e,h,i,j,k;if(f.debug("Entity tile selected for entity "+a.id+" within '"+b.id+"' scope"),f.debug(a),f.debug(b),null==g.selectedEntities[b.id][a.id]){for(g.selectedEntities[b.id][a.id]=a,i=a.images,c=0,e=i.length;e>c;c++)k=i[c],g.images[k]=a.label;g.$emit("entitySelected",a,g.annotation),g.selectAnnotation(void 0)}else{for(j=a.images,d=0,h=j.length;h>d;d++)k=j[d],delete g.images[k];g.$emit("entityDeselected",a,g.annotation)}return g.updateRelatedPosts()}}]),angular.module("wordlift.editpost.widget.directives.wlClassificationBox",[]).directive("wlClassificationBox",["$log",function(a){return{restrict:"E",scope:!0,transclude:!0,template:'<div class="classification-box">\n	<div class="box-header">\n          <h5 class="label">\n            {{box.label}}\n            <span ng-hide="addEntityFormIsVisible" ng-click="openAddEntityForm()" class="button" ng-class="{ \'button-primary selected wl-button\' : hasAnalysis(), \'preview\' : !hasAnalysis() }">Add entity</span>\n          </h5>\n          <wl-entity-form ng-show="addEntityFormIsVisible" entity="newEntity" box="box" on-submit="closeAddEntityForm()"></wl-entity-form>\n          <div class="wl-selected-items-wrapper">\n            <span ng-class="\'wl-\' + entity.mainType" ng-repeat="(id, entity) in selectedEntities[box.id]" class="wl-selected-item">\n              {{ entity.label}}\n              <i class="wl-deselect" ng-click="onSelectedEntityTile(entity, box)"></i>\n            </span>\n          </div>\n        </div>\n  			<div class="box-tiles">\n          <div ng-transclude></div>\n  		  </div>\n      </div>	',link:function(b,c,d,e){return b.addEntityFormIsVisible=!1,b.openAddEntityForm=function(){return b.isThereASelection||null!=b.annotation?(b.addEntityFormIsVisible=!0,null!=b.annotation?void a.debug("There is a current annotation already. Nothing to do"):b.createTextAnnotationFromCurrentSelection()):void b.addError("Select a text or an existing annotation in order to create a new entity. Text selections are valid only if they do not overlap other existing annotations.")},b.closeAddEntityForm=function(){return b.addEntityFormIsVisible=!1,b.addNewEntityToAnalysis(b.box)},b.hasSelectedEntities=function(){return Object.keys(b.selectedEntities[b.box.id]).length>0}},controller:function(a,b,c){var d;return a.tiles=[],a.boxes[a.box.id]=a,d=this,d.addTile=function(b){return a.tiles.push(b)},d.closeTiles=function(){var b,c,d,e,f;for(d=a.tiles,e=[],b=0,c=d.length;c>b;b++)f=d[b],e.push(f.close());return e}}}}]),angular.module("wordlift.editpost.widget.directives.wlEntityForm",[]).directive("wlEntityForm",["configuration","$window","$log",function(a,b,c){return{restrict:"E",scope:{entity:"=",onSubmit:"&",box:"="},template:'<div name="wordlift" class="wl-entity-form">\n<div ng-show="entity.images.length > 0">\n    <img ng-src="{{entity.images[0]}}" wl-on-error="removeCurrentImage()" />\n</div>\n<div>\n    <label class="wl-required">Entity label</label>\n    <input type="text" ng-model="entity.label" ng-disabled="checkEntityId(entity.id)" />\n</div>\n<div ng-hide="isInternal()">\n    <label class="wl-required">Entity type</label>\n    <select ng-hide="hasOccurences()" ng-model="entity.mainType" ng-options="type.id as type.name for type in supportedTypes" ></select>\n    <input ng-show="hasOccurences()" type="text" ng-value="getCurrentTypeUri()" disabled="true" />\n</div>\n<div>\n    <label class="wl-required">Entity Description</label>\n    <textarea ng-model="entity.description" rows="6" ng-disabled="isInternal()"></textarea>\n</div>\n<div ng-hide="isInternal()">\n    <label ng-show="checkEntityId(entity.id)" class="wl-required">Entity Id</label>\n    <input ng-show="checkEntityId(entity.id)" type="text" ng-model="entity.id" disabled="true" />\n</div>\n<div ng-hide="isInternal()">\n    <label>Entity Same as</label>\n    <input type="text" ng-model="entity.sameAs" />\n    <div ng-show="entity.suggestedSameAs.length > 0" class="wl-suggested-sameas-wrapper">\n      <h5>same as suggestions</h5>\n      <div ng-click="setSameAs(sameAs)" ng-class="{ \'active\': entity.sameAs == sameAs }" class="wl-sameas" ng-repeat="sameAs in entity.suggestedSameAs">{{sameAs}}</div>\n    </div>\n</div>\n<div ng-hide="isInternal()" class="wl-buttons-wrapper">\n  <span class="button button-primary wl-button" ng-click="onSubmit()">Add</span>\n</div>\n<div ng-show="isInternal()" class="wl-buttons-wrapper">\n  <span class="button button-primary wl-button" ng-click="linkTo(\'lod\')">View Linked Data<i class="wl-link"></i></span>\n  <span class="button button-primary wl-button" ng-click="linkTo(\'edit\')">Edit<i class="wl-link"></i></span>\n</div>\n</div>',link:function(d,e,f,g){var h,i,j,k,l;for(d.configuration=a,d.removeCurrentImage=function(){var a;return a=d.entity.images.shift(),c.warn("Removed "+a+" from entity "+d.entity.id+" images collection")},d.getCurrentTypeUri=function(){var b,c,e,f;for(e=a.types,b=0,c=e.length;c>b;b++)if(f=e[b],f.css==="wl-"+d.entity.mainType)return f.uri},d.isInternal=function(){return d.entity.id.startsWith(a.datasetUri)?!0:!1},d.linkTo=function(a){return b.location.href=ajaxurl+"?action=wordlift_redirect&uri="+b.encodeURIComponent(d.entity.id)+"&to="+a},d.hasOccurences=function(){return d.entity.occurrences.length>0},d.setSameAs=function(a){return d.entity.sameAs=a},d.checkEntityId=function(a){return/^(f|ht)tps?:\/\//i.test(a)},h=[],k=a.types,i=0,j=k.length;j>i;i++)l=k[i],h[l.css.replace("wl-","")]=l.uri;return d.supportedTypes=function(){var b,c,d,e;for(d=a.types,e=[],b=0,c=d.length;c>b;b++)l=d[b],e.push({id:l.css.replace("wl-",""),name:l.uri});return e}(),d.box?d.supportedTypes=function(){var a,b,c,e;for(c=d.box.registeredTypes,e=[],a=0,b=c.length;b>a;a++)l=c[a],e.push({id:l,name:h[l]});return e}():void 0}}}]),angular.module("wordlift.editpost.widget.directives.wlEntityTile",[]).directive("wlEntityTile",["configuration","$log",function(a,b){return{require:"^wlClassificationBox",restrict:"E",scope:{entity:"=",isSelected:"=",onEntitySelect:"&"},template:'<div ng-class="\'wl-\' + entity.mainType" class="entity">\n        <div class="entity-header">\n    \n          <i ng-click="onEntitySelect()" ng-hide="annotation" ng-class="{ \'wl-selected\' : isSelected, \'wl-unselected\' : !isSelected }"></i>\n          <i ng-click="onEntitySelect()" class="type"></i>\n          <span class="label" ng-click="onEntitySelect()">{{entity.label}}</span>\n\n          <small ng-show="entity.occurrences.length > 0">({{entity.occurrences.length}})</small>\n          <span ng-show="isInternal()" class="dashicons dashicons-tag wl-internal"></span>  \n          <i ng-class="{ \'wl-more\': isOpened == false, \'wl-less\': isOpened == true }" ng-click="toggle()"></i>\n  </div>\n        <div class="details" ng-show="isOpened">\n          <wl-entity-form entity="entity" on-submit="toggle()"></wl-entity-form>\n        </div>\n</div>',link:function(b,c,d,e){return e.addTile(b),b.isOpened=!1,b.isInternal=function(){return b.entity.id.startsWith(a.datasetUri)?!0:!1},b.open=function(){return b.isOpened=!0},b.close=function(){return b.isOpened=!1},b.toggle=function(){return b.isOpened||e.closeTiles(),b.isOpened=!b.isOpened}}}}]),angular.module("wordlift.editpost.widget.directives.wlEntityInputBox",[]).directive("wlEntityInputBox",function(){return{restrict:"E",scope:{entity:"="},template:"        <div>\n\n          <input type='text' name='wl_entities[{{entity.id}}][uri]' value='{{entity.id}}'>\n          <input type='text' name='wl_entities[{{entity.id}}][label]' value='{{entity.label}}'>\n          <textarea name='wl_entities[{{entity.id}}][description]'>{{entity.description}}</textarea>\n          <input type='text' name='wl_entities[{{entity.id}}][main_type]' value='wl-{{entity.mainType}}'>\n\n          <input ng-repeat=\"type in entity.types\" type='text'\n          	name='wl_entities[{{entity.id}}][type][]' value='{{type}}' />\n          <input ng-repeat=\"image in entity.images\" type='text'\n            name='wl_entities[{{entity.id}}][image][]' value='{{image}}' />\n          <input ng-repeat=\"sameAs in entity.sameAs\" type='text'\n            name='wl_entities[{{entity.id}}][sameas][]' value='{{sameAs}}' />\n          \n          <div ng-repeat=\"(property, values) in entity.properties\">\n            <input ng-repeat=\"propertyValue in values\" type='text'\n              name='wl_entities[{{entity.id}}][properties][{{property}}][]' value='{{propertyValue}}' />\n          </div>\n         \n</div>"}}),angular.module("wordlift.editpost.widget.services.AnalysisService",[]).service("AnalysisService",["configuration","$log","$http","$rootScope",function(a,b,c,d){var f,g,h,i,j,k,l,m,n,o,p,q,r;for(r=function(a){var b;for(null==a&&(a=8),b="";b.length<a;)b+=Math.random().toString(36).substr(2);return b.substr(0,a)},m=function(a,b){return g(g({},a),b)},g=function(a,b){var c,d;for(c in b)d=b[c],a[c]=d;return a},h=function(a,b,c){var d,e;for(e in a)if(d=a[e],d.start===b&&d.end===c)return d},p={_isRunning:!1,_currentAnalysis:void 0,_supportedTypes:[],_defaultType:"thing"},p.cleanAnnotations=function(a,c){var d,f,g,h,i,j,k,l,m,n;null==c&&(c=[]),l=a.annotations;for(f in l)if(d=l[f],d.start>0&&d.end>d.start){for(g=function(){n=[];for(var a=m=d.start,b=d.end;b>=m?b>=a:a>=b;b>=m?a++:a--)n.push(a);return n}.apply(this),h=!1,i=0,j=g.length;j>i;i++){k=g[i],e.call(c,k)>=0&&(h=!0);break}h?(b.warn("Annotation with id: "+f+" start: "+d.start+" end: "+d.end+" overlaps an existing annotation"),b.debug(d),this.deleteAnnotation(a,f)):c=c.concat(g)}return a},n=a.classificationBoxes,i=0,k=n.length;k>i;i++)for(f=n[i],o=f.registeredTypes,j=0,l=o.length;l>j;j++)q=o[j],e.call(p._supportedTypes,q)<0&&p._supportedTypes.push(q);return p.createEntity=function(a){var b;return null==a&&(a={}),b={id:"local-entity-"+r(32),label:"",description:"",mainType:"thing",types:[],images:[],confidence:1,occurrences:[],annotations:{}},m(b,a)},p.deleteAnnotation=function(a,c){var d,e,f,g,h;if(b.warn("Going to remove overlapping annotation with id "+c),null!=a.annotations[c]){for(h=a.annotations[c].entityMatches,e=f=0,g=h.length;g>f;e=++f)d=h[e],delete a.entities[d.entityId].annotations[c];delete a.annotations[c]}return a},p.createAnnotation=function(a){var b;return null==a&&(a={}),b={id:"urn:local-text-annotation-"+r(32),text:"",start:0,end:0,entities:[],entityMatches:[]},m(b,a)},p.parse=function(c){var d,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A;t=a.entities;for(j in t)o=t[j],c.entities[j]=o;u=c.entities;for(j in u)i=u[j],i.label||b.warn("Label missing for entity "+j),i.description||b.warn("Description missing for entity "+j),i.sameAs||(b.warn("sameAs missing for entity "+j),i.sameAs=[],null!=(v=a.entities[j])&&(v.sameAs=[]),b.debug("Schema.org sameAs overridden for entity "+j)),w=i.mainType,e.call(this._supportedTypes,w)<0&&(b.warn("Schema.org type "+i.mainType+" for entity "+j+" is not supported from current classification boxes configuration"),i.mainType=this._defaultType,null!=(x=a.entities[j])&&(x.mainType=this._defaultType),b.debug("Schema.org type overridden for entity "+j)),i.id=j,i.occurrences=[],i.annotations={},i.confidence=1;y=c.annotations;for(j in y)for(d=y[j],d.id=j,d.entities={},c.annotations[j].entityMatches=function(){var b,c,e,f;for(e=d.entityMatches,f=[],b=0,c=e.length;c>b;b++)g=e[b],g.entityId!==a.currentPostUri&&f.push(g);return f}(),z=c.annotations[j].entityMatches,k=l=0,m=z.length;m>l;k=++l)g=z[k],c.entities[g.entityId].label||(c.entities[g.entityId].label=d.text,b.debug("Missing label retrived from related annotation for entity "+g.entityId)),c.entities[g.entityId].annotations[j]=d,c.annotations[j].entities[g.entityId]=c.entities[g.entityId];A=c.entities;for(j in A){i=A[j],r=c.annotations;for(f in r){for(d=r[f],p=1,s=d.entityMatches,q=0,n=s.length;n>q;q++)h=s[q],null!=h.entityId&&h.entityId===j&&(p=h.confidence);i.confidence=i.confidence*p}}return c},p.getSuggestedSameAs=function(a){var b;return b=this._innerPerform(a).then(function(a){var b,c,e,f;f=[],e=a.data.entities;for(c in e)b=e[c],c.startsWith("http")&&f.push(c);return d.$broadcast("sameAsRetrieved",f)})},p._innerPerform=function(a){return b.info("Start to performing analysis"),c({method:"post",url:ajaxurl+"?action=wordlift_analyze",data:a})},p._updateStatus=function(a){return p._isRunning=a,d.$broadcast("analysisServiceStatusUpdated",a)},p.perform=function(a){var c;return p._currentAnalysis?(b.warn("Analysis already runned! Nothing to do ..."),void p._updateStatus(!1)):(p._updateStatus(!0),c=this._innerPerform(a),c.then(function(a){return p._currentAnalysis=a.data,d.$broadcast("analysisPerformed",p.parse(a.data))}),c["catch"](function(a){return b.error(a.data),d.$broadcast("analysisFailed",a.data)}),c["finally"](function(a){return p._updateStatus(!1)}))},p.preselect=function(c,d){var f,g,i,j,k,l,m,n,o,p;for(b.debug("Going to perform annotations preselection"),o=[],k=0,l=d.length;l>k;k++)if(f=d[k],f.start!==f.end){p=h(c.annotations,f.start,f.end),null==p&&(b.warn("Annotation "+f.start+":"+f.end+" for entityId "+f.uri+" misses in the analysis"),p=this.createAnnotation({start:f.start,end:f.end,text:f.label}),c.annotations[p.id]=p),i=c.entities[f.uri],m=a.entities;for(j in m)g=m[j],n=f.uri,e.call(g.sameAs,n)>=0&&(i=c.entities[g.id]);null!=i?(c.entities[i.id].occurrences.push(p.id),null==c.entities[i.id].annotations[p.id]?(c.entities[i.id].annotations[p.id]=p,c.annotations[p.id].entityMatches.push({entityId:i.id,confidence:1}),o.push(c.annotations[p.id].entities[i.id]=c.entities[i.id])):o.push(void 0)):b.warn("Entity with uri "+f.uri+" is missing both in analysis results and in local storage")}else b.warn("There is a broken empty annotation for entityId "+f.uri);return o},p}]),angular.module("wordlift.editpost.widget.services.EditorService",["wordlift.editpost.widget.services.AnalysisService"]).service("EditorService",["configuration","AnalysisService","$log","$http","$rootScope",function(a,c,d,f,g){var h,i,j,k,l,m,n,o;return h="\ufeff",m=function(a){var c,d,e,f,g;for(g=b.create(a),e=/<(\w+)[^>]*\sitemid="([^"]+)"[^>]*>([^<]*)<\/\1>/gim,f=[];d=e.exec(a);)c={start:g.html2text(d.index),end:g.html2text(d.index+d[0].length),uri:d[2],label:d[3]},f.push(c);return f},n=function(a){var b,c,d,e,f,g;for(e=[],c=0,d=a.length;d>c;c++)b=a[c],e=e.concat(function(){g=[];for(var a=f=b.start,c=b.end;c>=f?c>=a:a>=c;c>=f?a++:a--)g.push(a);return g}.apply(this));return e},l=function(){return tinyMCE.get("content")},k=function(b,c){var d,e,f,g,h,i;for(e=l(),e.dom.addClass(b.id,"disambiguated"),h=a.types,f=0,g=h.length;g>f;f++)i=h[f],e.dom.removeClass(b.id,i.css);return e.dom.removeClass(b.id,"unlinked"),e.dom.addClass(b.id,"wl-"+c.mainType),d=e.dom.getAttrib(b.id,"itemid"),e.dom.setAttrib(b.id,"itemid",c.id),d},j=function(a,b){var c,d;return d=l(),d.dom.removeClass(a.id,"disambiguated"),d.dom.removeClass(a.id,"wl-"+b.mainType),c=d.dom.getAttrib(a.id,"itemid"),d.dom.setAttrib(a.id,"itemid",""),c},i=function(a){var b,c,d,e,f,g,h;if(d=l(),h=[],""===a)return h;for(c=d.dom.select("span.textannotation"),f=0,g=c.length;g>f;f++)b=c[f],e=d.dom.getAttrib(b.id,"itemid"),e===a&&h.push(b.id);return h},g.$on("analysisPerformed",function(a,b){return null!=b&&null!=b.annotations?o.embedAnalysis(b):void 0}),g.$on("entitySelected",function(a,b,c){var d,e,f,h,j,l,m,n;if(e=[],null!=c)e.push(k(b.annotations[c],b));else{n=b.annotations;for(h in n)d=n[h],e.push(k(d,b))}for(j=0,l=e.length;l>j;j++)f=e[j],f&&(m=i(f),g.$broadcast("updateOccurencesForEntity",f,m));return m=i(b.id),g.$broadcast("updateOccurencesForEntity",b.id,m)}),g.$on("entityDeselected",function(a,b,c){var d,e,f,h,k,l,m,n;if(e=[],null!=c)j(b.annotations[c],b);else{n=b.annotations;for(h in n)d=n[h],j(d,b)}for(k=0,l=e.length;l>k;k++)f=e[k],f&&(m=i(f),g.$broadcast("updateOccurencesForEntity",f,m));return m=i(b.id),g.$broadcast("updateOccurencesForEntity",b.id,m)}),o={hasSelection:function(){var a,b;return a=l(),null!=a?a.selection.isCollapsed()?!1:(b=/<([\/]*[a-z]+)[^<]*>/,b.test(a.selection.getContent())?(d.warn("The selection overlaps html code"),!1):!0):!1},isEditor:function(a){var b;return b=a(),b.id===a.id},updateContentEditableStatus:function(a){var b;return b=l(),b.getBody().setAttribute("contenteditable",a)},createTextAnnotationFromCurrentSelection:function(){var a,e,f,i,j,k,m,n;return e=l(),e.selection.isCollapsed()?void d.warn("Invalid selection! The text annotation cannot be created"):(i=""+e.selection.getSel(),j=c.createAnnotation({text:i}),k='<span id="'+j.id+'" class="textannotation unlinked selected">'+e.selection.getContent()+"</span>"+h,e.selection.setContent(k),a=e.getContent({format:"raw"}),n=b.create(a),f=a.indexOf(k),m=n.html2text(f),j.start=m,j.end=j.start+i.length,g.$broadcast("textAnnotationAdded",j))},selectAnnotation:function(a){var b,c,d,e,f;for(c=l(),f=c.dom.select("span.textannotation"),d=0,e=f.length;e>d;d++)b=f[d],c.dom.removeClass(b.id,"selected");return g.$broadcast("textAnnotationClicked",void 0),c.dom.hasClass(a,"textannotation")?(c.dom.addClass(a,"selected"),g.$broadcast("textAnnotationClicked",a)):void 0},embedAnalysis:function(a){return function(a){var f,i,j,k,o,p,q,r,s,t,u,v,w,x;for(j=l(),r=j.getContent({format:"raw"}),p=m(r),c.cleanAnnotations(a,n(p)),c.preselect(a,p);r.match(/<(\w+)[^>]*\sclass="textannotation[^"]*"[^>]*>([^<]+)<\/\1>/gim,"$2");)r=r.replace(/<(\w+)[^>]*\sclass="textannotation[^"]*"[^>]*>([^<]*)<\/\1>/gim,"$2");x=b.create(r),v=a.annotations;for(i in v)if(f=v[i],0!==f.entityMatches.length){for(k='<span id="'+i+'" class="textannotation',w=f.entityMatches,t=0,u=w.length;u>t;t++)o=w[t],q=a.entities[o.entityId],e.call(q.occurrences,i)>=0&&(k+=" disambiguated wl-"+q.mainType+'" itemid="'+q.id);k+='">',x.insertHtml(k,{text:f.start}),x.insertHtml("</span>",{text:f.end})}else d.warn("Annotation "+f.text+" ["+f.start+":"+f.end+"] with id "+f.id+" has no entity matches!");return r=x.getHtml(),r=r.replace(/<\/span>/gim,"</span>"+h),g.$broadcast("analysisEmbedded"),s=j.isDirty(),j.setContent(r,{format:"raw"}),j.isNotDirty=!s}}(this)}}]),angular.module("wordlift.editpost.widget.services.RelatedPostDataRetrieverService",[]).service("RelatedPostDataRetrieverService",["configuration","$log","$http","$rootScope",function(a,b,c,d){var e;return e={},e.load=function(e){var f;return null==e&&(e=[]),f="admin-ajax.php?action=wordlift_related_posts&post_id="+a.currentPostId,b.debug("Going to find related posts"),b.debug(e),c({method:"post",url:f,data:e}).success(function(a){return b.debug(a),d.$broadcast("relatedPostsLoaded",a)}).error(function(a,c){return b.warn("Error loading related posts")})},e}]),angular.module("wordlift.editpost.widget.providers.ConfigurationProvider",[]).provider("configuration",function(){var a,b;return a=void 0,b={setConfiguration:function(b){return a=b},$get:function(){return a}}}),a=jQuery,angular.module("wordlift.editpost.widget",["wordlift.ui.carousel","wordlift.utils.directives","wordlift.editpost.widget.providers.ConfigurationProvider","wordlift.editpost.widget.controllers.EditPostWidgetController","wordlift.editpost.widget.directives.wlClassificationBox","wordlift.editpost.widget.directives.wlEntityForm","wordlift.editpost.widget.directives.wlEntityTile","wordlift.editpost.widget.directives.wlEntityInputBox","wordlift.editpost.widget.services.AnalysisService","wordlift.editpost.widget.services.EditorService","wordlift.editpost.widget.services.RelatedPostDataRetrieverService"]).config(function(a){return a.setConfiguration(window.wordlift)}),a(c=a('<div id="wordlift-edit-post-wrapper" ng-controller="EditPostWidgetController">\n	\n      <div class="wl-error" ng-repeat="item in errors">\n        <span class="wl-msg">{{ item.msg }}</span>\n      </div>\n\n      <h3 class="wl-widget-headline">\n        <span>Semantic tagging</span>\n        <span ng-show="isRunning" class="wl-spinner"></span>\n      </h3>\n      \n      <div ng-show="annotation">\n        <h4 class="wl-annotation-label">\n          <i class="wl-annotation-label-icon"></i>\n          {{ analysis.annotations[ annotation ].text }} \n          <small>[ {{ analysis.annotations[ annotation ].start }}, {{ analysis.annotations[ annotation ].end }} ]</small>\n          <i class="wl-annotation-label-remove-icon" ng-click="selectAnnotation(undefined)"></i>\n        </h4>\n      </div>\n\n      <wl-classification-box ng-repeat="box in configuration.classificationBoxes">\n        <div ng-hide="annotation" class="wl-without-annotation">\n          <wl-entity-tile is-selected="isEntitySelected(entity, box)" on-entity-select="onSelectedEntityTile(entity, box)" entity="entity" ng-repeat="entity in analysis.entities | filterEntitiesByTypesAndRelevance:box.registeredTypes"></wl-entity>\n        </div>  \n        <div ng-show="annotation" class="wl-with-annotation">\n          <wl-entity-tile is-selected="isLinkedToCurrentAnnotation(entity)" on-entity-select="onSelectedEntityTile(entity, box)" entity="entity" ng-repeat="entity in analysis.annotations[annotation].entities | filterEntitiesByTypes:box.registeredTypes"" ></wl-entity>\n        </div>  \n      </wl-classification-box>\n\n      <h3 class="wl-widget-headline"><span>Suggested images</span></h3>\n      <div wl-carousel>\n        <div ng-repeat="(image, label) in images" class="wl-card" wl-carousel-pane>\n          <div class="wl-card-image"> \n            <img ng-src="{{image}}" wl-fallback="{{configuration.defaultThumbnailPath}}" />\n          </div>\n        </div>\n      </div>\n\n      <h3 class="wl-widget-headline"><span>Related posts</span></h3>\n      <div wl-carousel>\n        <div ng-repeat="post in relatedPosts" class="wl-card" wl-carousel-pane>\n          <div class="wl-card-image"> \n            <img ng-src="{{post.thumbnail}}" wl-fallback="{{configuration.defaultThumbnailPath}}" />\n          </div>\n          <div class="wl-card-title">\n            <a ng-href="{{post.link}}">{{post.post_title}}</a>\n          </div>\n        </div>\n      </div>\n      \n      <div class="wl-entity-input-boxes">\n        <wl-entity-input-box annotation="annotation" entity="entity" ng-repeat="entity in analysis.entities | isEntitySelected"></wl-entity-input-box>\n        <div ng-repeat="(box, entities) in selectedEntities">\n          <input type=\'text\' name=\'wl_boxes[{{box}}][]\' value=\'{{id}}\' ng-repeat="(id, entity) in entities">\n        </div> \n      </div>   \n    </div>').appendTo("#wordlift-edit-post-outer-wrapper"),d=angular.bootstrap(a("#wordlift-edit-post-wrapper"),["wordlift.editpost.widget"]),tinymce.PluginManager.add("wordlift",function(a,c){
var e;if("content"===a.id)return e=function(a,b,c){switch(tinymce.majorVersion){case"4":return a.on(b,c);case"3":return a["on"+b].add(c)}},d.invoke(["EditorService","$rootScope","$log",function(a,b,c){var d,e,f,g,h,i;for(h=["setMarkers","toViews"],i=[],d=0,e=h.length;e>d;d++){if(f=h[d],null!=wp.mce.views[f]){g=wp.mce.views[f],c.warn("Override wp.mce.views method "+f+"() to prevent shortcodes rendering"),wp.mce.views[f]=function(a){return a},b.$on("analysisEmbedded",function(a){return c.info("Going to restore wp.mce.views method "+f+"()"),wp.mce.views[f]=g}),b.$on("analysisFailed",function(a){return c.info("Going to restore wp.mce.views method "+f+"()"),wp.mce.views[f]=g});break}i.push(void 0)}return i}]),e(a,"LoadContent",function(c){return d.invoke(["AnalysisService","EditorService","$rootScope","$log",function(c,d,e,f){return e.$apply(function(){var e,g;return e=a.getContent({format:"raw"}),g=b.create(e).getText(),g.match(/[a-zA-Z0-9]+/)?(d.updateContentEditableStatus(!1),c.perform(g)):f.warn("Blank content: nothing to do!")})}])}),e(a,"NodeChange",function(a){return d.invoke(["AnalysisService","EditorService","$rootScope","$log",function(a,b,c,d){return a._currentAnalysis&&c.$apply(function(){return c.selectionStatus=b.hasSelection()}),!0}])}),e(a,"Click",function(a){return d.invoke(["AnalysisService","EditorService","$rootScope","$log",function(b,c,d,e){return b._currentAnalysis&&d.$apply(function(){return c.selectAnnotation(a.target.id)}),!0}])})}))}).call(this);