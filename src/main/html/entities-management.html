<!DOCTYPE html>
<style>
  [ng-cloak] {
  	display: none;
  }
</style>
<div id='wordliftApp' ng-cloak ng-controller='EntitiesCtrl' ng-view></div>
<script>
  (function() {
  
    angular.element(document).ready(function() {
      angular.module("wordliftApp", []).constant("BASE_URL", "../wp-content/plugins/wordlift/html/").constant("ENTITIES_DEFAULT_LIMIT", 10).constant("ENTITY_DEFAULT_LIMIT", 100).constant("DEFAULT_LIMIT", 10).config([
        "BASE_URL", "$httpProvider", "$locationProvider", "$routeProvider", function(BASE_URL, $httpProvider, $locationProvider, $routeProvider) {
          return $routeProvider.when("/list", {
            templateUrl: BASE_URL + "/entities-list.html",
            controller: "EntitiesCtrl"
          }).when("/edit/:subject", {
            templateUrl: BASE_URL + "/entities-edit.html",
            controller: "EntityCtrl"
          }).otherwise({
            redirectTo: "/list"
          });
        }
      ]).controller("EntityCtrl", [
        "ENTITY_DEFAULT_LIMIT", "EntitiesService", "$location", "$routeParams", "$scope", "$log", function(ENTITY_DEFAULT_LIMIT, EntitiesService, $location, $routeParams, $scope, $log) {
          var event, subject;
          event = "entity";
          subject = $routeParams["subject"];
          $scope.$on(event, function(event, data) {
            return $scope.data = data;
          });
          $scope.$on("property.update", function(event, data) {
            return $scope.goToPage(0);
          });
          $scope.goToPreviousPage = function() {
            return $scope.goToPage($scope.data.page - 1);
          };
          $scope.goToNextPage = function() {
            return $scope.goToPage($scope.data.page + 1);
          };
          $scope.getPages = function() {
            var _i, _ref, _results;
            return (function() {
              _results = [];
              for (var _i = 1, _ref = $scope.data.pages; 1 <= _ref ? _i <= _ref : _i >= _ref; 1 <= _ref ? _i++ : _i--){ _results.push(_i); }
              return _results;
            }).apply(this);
          };
          $scope.goToPage = function(page) {
            return EntitiesService.list("wordlift.entity", event, {
              "subject": subject
            }, page * ENTITY_DEFAULT_LIMIT, ENTITY_DEFAULT_LIMIT);
          };
          $scope.isImage = function(url) {
            var matches;
            if (!(url != null)) {
              return;
            }
            matches = url.match(/\.(jpg|jpeg|svg|gif|png)$/i);
            return matches != null;
          };
          $scope.setEditMode = function(property, editMode) {
            if (editMode) {
              $scope.tmp = {
                property: angular.copy(property)
              };
            }
            return property.editMode = editMode;
          };
          $scope.saveProperty = function(property) {
            EntitiesService.list("wordlift.property", "property.update", {
              "subject": subject
            }, null, null, "DELETE", $scope.tmp.property);
            return EntitiesService.list("wordlift.property", "property.update", {
              "subject": subject
            }, null, null, "POST", property);
          };
          $scope.deleteProperty = function(property) {
            $scope.tmp = {
              property: property
            };
            return Avgrund.show("#delete-confirmation-dialog");
          };
          $scope.cancelDeleteProperty = function() {
            delete $scope.tmp.property;
            return Avgrund.hide("#delete-confirmation-dialog");
          };
          $scope.confirmDeleteProperty = function() {
            var property;
            Avgrund.hide("#delete-confirmation-dialog");
            property = $scope.tmp.property;
            return EntitiesService.list("wordlift.property", "property.update", {
              "subject": subject
            }, null, null, "DELETE", property);
          };
          return $scope.goToPage(0);
        }
      ]).controller("EntitiesCtrl", [
        "ENTITIES_DEFAULT_LIMIT", "EntitiesService", "$location", "$scope", "$log", function(ENTITIES_DEFAULT_LIMIT, EntitiesService, $location, $scope, $log) {
          $scope.filters = {
            nameFilter: "",
            languagesFilter: ""
          };
          $scope.data = {
            page: 0,
            pages: 1,
            content: []
          };
          $scope.$on("entities", function(event, data) {
            return $scope.data = data;
          });
          $scope.getTypeName = function(type) {
            var matches;
            matches = type.match(/([^\/]*)$/i);
            if (matches != null) {
              return matches[0];
            }
          };
          $scope.getEntityName = function(entity) {
            var matches;
            matches = entity.subject.match(/([^\/]*)$/i);
            if (matches != null) {
              return matches[0];
            }
          };
          $scope.getPages = function() {
            var _i, _ref, _results;
            return (function() {
              _results = [];
              for (var _i = 1, _ref = $scope.data.pages; 1 <= _ref ? _i <= _ref : _i >= _ref; 1 <= _ref ? _i++ : _i--){ _results.push(_i); }
              return _results;
            }).apply(this);
          };
          $scope.goToPage = function(page) {
            return EntitiesService.list("wordlift.entities", "entities", {
              name: $scope.filters.nameFilter,
              languages: $scope.filters.languagesFilter
            }, page * ENTITIES_DEFAULT_LIMIT, ENTITIES_DEFAULT_LIMIT);
          };
          $scope.goToPreviousPage = function() {
            return $scope.goToPage($scope.data.page - 1);
          };
          $scope.goToNextPage = function() {
            return $scope.goToPage($scope.data.page + 1);
          };
          $scope.goToEntity = function(entity) {
            return $location.path("/edit/" + $scope.getEntityName(entity));
          };
          $scope.filter = function() {
            return $scope.goToPage(0);
          };
          return $scope.goToPage(0);
        }
      ]).service("EntitiesService", [
        "DEFAULT_LIMIT", "$http", "$rootScope", "$log", function(DEFAULT_LIMIT, $http, $rootScope, $log) {
          return {
            list: function(action, event, params, offset, limit, method, data) {
              if (params == null) {
                params = [];
              }
              if (offset == null) {
                offset = 0;
              }
              if (limit == null) {
                limit = DEFAULT_LIMIT;
              }
              if (method == null) {
                method = "GET";
              }
              if (data == null) {
                data = null;
              }
              params["action"] = action;
              params["limit"] = limit;
              params["offset"] = offset;
              return $http({
                method: method,
                url: "admin-ajax.php",
                params: params,
                data: data
              }).success(function(data, status, headers, config) {
                return $rootScope.$broadcast(event, data);
              }).error(function(data, status, headers, config) {
                return $rootScope.$broadcast("error", data);
              });
            }
          };
        }
      ]);
      return angular.bootstrap(document.getElementById("wordliftApp"), ["wordliftApp"]);
    });
  
  }).call(this);
</script>
